{% extends 'base.html' %}

{% block title %}Multiplayer Game - Real Vs AI{% endblock %}

{% block content %}
<!-- Game Header -->
<div class="game-header mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-4">
                <div class="turn-counter">
                    Turn: <span id="multiplayerTurn">{{ game.current_turn }}/{{ game.total_turns }}</span>
                </div>
            </div>
            <div class="col-4 text-center">
                <h2>Real Vs AI</h2>
                <p class="mb-0">Multiplayer Mode</p>
            </div>
            <div class="col-4 text-end">
                <div class="score-counter">
                    {% if player_number > 0 %}
                        Your Score: <span id="player{{ player_number }}Score">{{ players[player_number-1].score }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Players Scoreboard -->
<div class="container mb-4">
    <div class="card bg-dark">
        <div class="card-body">
            <h4 class="card-title mb-3">Players</h4>
            <div class="row">
                {% for player in players %}
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-secondary {% if player.number == player_number %}border border-primary{% endif %}">
                        <div class="card-body">
                            <h5 class="card-title">
                                {% if player.number == 1 %}
                                    <i class="fas fa-crown text-warning me-1"></i> <!-- Host icon -->
                                {% endif %}
                                {% if player.avatar %}
                                    <span class="me-2">{{ player.avatar }}</span>
                                {% else %}
                                    <i class="fas fa-user-circle me-2"></i>
                                {% endif %}
                                {{ player.name }}
                            </h5>
                            <p class="card-text">
                                Score: <span id="player{{ player.number }}ScoreDisplay">{{ player.score }}</span>
                            </p>
                            {% if player.number == player_number %}
                            <span class="badge bg-primary">You</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if players|length < 4 %}
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-dark border border-secondary border-dashed">
                        <div class="card-body text-center">
                            <h5 class="card-title text-muted">
                                <i class="fas fa-user-plus me-1"></i>
                                Empty Slot
                            </h5>
                            <p class="card-text text-muted small">
                                Share the session ID for others to join
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Session ID for sharing -->
<div class="container mb-4">
    <div class="session-info">
        <strong>Session ID:</strong> {{ game.session_id }}
        <button class="btn btn-sm btn-outline-light ms-2" onclick="copySessionId()">
            <i class="fas fa-copy"></i> Copy
        </button>
    </div>
</div>

<!-- Game Area -->
<div class="container">
    {% if role == 'host' and game.current_turn <= game.total_turns and not game.completed %}
        <div class="row justify-content-center mb-4">
            <div class="col-12 text-center mb-4">
                <h3>Which image is REAL?</h3>
                <p class="text-muted">Click on the image you think is a real photo</p>
            </div>
            
            <!-- Feedback Message (hidden initially) -->
            <div id="feedback" class="feedback-message" style="display: none;"></div>
        </div>
        
        <div class="row">
            <!-- Image 1 -->
            <div class="col-md-6 mb-4">
                <div class="image-container" id="image1" data-type="{{ image1_type }}">
                    <img src="{{ url_for('static', filename=image1.replace('static/', '')) }}" alt="Image 1" class="img-fluid">
                </div>
            </div>
            
            <!-- Image 2 -->
            <div class="col-md-6 mb-4">
                <div class="image-container" id="image2" data-type="{{ image2_type }}">
                    <img src="{{ url_for('static', filename=image2.replace('static/', '')) }}" alt="Image 2" class="img-fluid">
                </div>
            </div>
        </div>
        
        <div class="row justify-content-center mt-3">
            <div class="col-md-6 text-center">
                <button id="submitMultiplayerAnswer" class="btn btn-primary btn-lg px-5" disabled>Submit Answer</button>
            </div>
        </div>
    {% elif role != 'host' and player_number > 0 and game.current_turn <= game.total_turns and not game.completed %}
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <div class="card bg-dark">
                    <div class="card-body">
                        <h3>Waiting for host to select images...</h3>
                        <p>The host is preparing the next round. Please wait.</p>
                        <div class="spinner-border text-primary mt-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% elif game.completed %}
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <div class="card bg-dark">
                    <div class="card-body">
                        <h3>Game Completed!</h3>
                        <div class="row mt-4">
                            {% for player in players %}
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card {% if player.number == player_number %}bg-primary{% else %}bg-secondary{% endif %}">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            {% if player.number == 1 %}
                                                <i class="fas fa-crown text-warning me-1"></i>
                                            {% endif %}
                                            {{ player.name }}
                                        </h5>
                                        <div class="display-4">{{ player.score }}</div>
                                        {% if player.number == player_number %}
                                        <span class="badge bg-light text-dark">You</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-4">
                            <a href="{{ url_for('index') }}" class="btn btn-primary">Return to Home</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <div class="card bg-dark">
                    <div class="card-body">
                        <h3>Observer Mode</h3>
                        <p>You are watching a multiplayer game in progress.</p>
                        <div class="row mt-4">
                            {% for player in players %}
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card bg-secondary">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            {% if player.number == 1 %}
                                                <i class="fas fa-crown text-warning me-1"></i>
                                            {% endif %}
                                            {{ player.name }}
                                        </h5>
                                        <div class="display-4">{{ player.score }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/confetti.min.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize JSConfetti with error handling
        let jsConfetti;
        try {
            jsConfetti = new JSConfetti();
        } catch (error) {
            console.warn('JSConfetti initialization failed:', error);
            // Create a fallback object with a no-op addConfetti method
            jsConfetti = { addConfetti: () => console.log('Confetti animation skipped') };
        }
        
        // Image selection handling
        const imageContainers = document.querySelectorAll('.image-container');
        const submitButton = document.getElementById('submitMultiplayerAnswer');
        const feedbackElement = document.getElementById('feedback');
        
        let selectedImage = null;
        
        // Initialize the game
        function initGame() {
            // Add click event listeners to image containers
            imageContainers.forEach(container => {
                container.addEventListener('click', function() {
                    // Remove selected class from all containers
                    imageContainers.forEach(c => c.classList.remove('selected'));
                    
                    // Add selected class to clicked container
                    this.classList.add('selected');
                    
                    // Store selected image type
                    selectedImage = this.getAttribute('data-type');
                    
                    // Enable submit button
                    if (submitButton) {
                        submitButton.disabled = false;
                    }
                });
            });
            
            // Add submit button event listener
            if (submitButton) {
                submitButton.addEventListener('click', submitMultiplayerAnswer);
            }
        }
        
        function submitMultiplayerAnswer() {
            if (!selectedImage) return;
            
            // Disable submit button while processing
            submitButton.disabled = true;
            
            // Get the form data
            const formData = new FormData();
            formData.append('selected', selectedImage);
            
            // Send AJAX request
            fetch('/submit_multiplayer_answer', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Handle response
                if (data.error) {
                    showFeedback(data.error, false);
                    return;
                }
                
                // Show feedback
                showFeedback(data.correct ? 'Correct!' : 'Wrong!', data.correct);
                
                // Update game state
                const multiplayerTurnElement = document.getElementById('multiplayerTurn');
                
                // Update player scores
                if (data.scores) {
                    // Update the individual player scores
                    for (let i = 1; i <= 4; i++) {
                        const scoreElement = document.getElementById(`player${i}Score`);
                        const scoreDisplayElement = document.getElementById(`player${i}ScoreDisplay`);
                        
                        if (scoreElement && data.scores[`player${i}`] !== undefined) {
                            scoreElement.textContent = data.scores[`player${i}`];
                        }
                        
                        if (scoreDisplayElement && data.scores[`player${i}`] !== undefined) {
                            scoreDisplayElement.textContent = data.scores[`player${i}`];
                        }
                    }
                }
                
                // Update turn counter
                if (multiplayerTurnElement) {
                    multiplayerTurnElement.textContent = `${data.turn}/${data.totalTurns}`;
                }
                
                // Wait for other player or redirect
                if (data.redirect) {
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1500);
                } else {
                    showWaitingMessage();
                    
                    // Poll for game state updates
                    pollGameState();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showFeedback('An error occurred. Please try again.', false);
                submitButton.disabled = false;
            });
        }
        
        function showFeedback(message, isCorrect) {
            if (!feedbackElement) return;
            
            feedbackElement.textContent = message;
            feedbackElement.className = 'feedback-message';
            feedbackElement.classList.add(isCorrect ? 'feedback-correct' : 'feedback-wrong');
            feedbackElement.style.display = 'block';
            
            // Show confetti celebration if the answer is correct
            if (isCorrect) {
                jsConfetti.addConfetti({
                    confettiColors: [
                        '#26ccff', '#a25afd', '#ff5e7e', '#88ff5a', '#fcff42', '#ffa62d', '#ff36ff'
                    ],
                    confettiNumber: 100,
                });
            }
        }
        
        function showWaitingMessage() {
            if (!feedbackElement) return;
            
            feedbackElement.textContent = 'Waiting for other players...';
            feedbackElement.className = 'feedback-message';
            feedbackElement.style.backgroundColor = 'var(--bs-info)';
            feedbackElement.style.color = 'white';
            feedbackElement.style.display = 'block';
        }
        
        function pollGameState() {
            // This would be implemented for real-time multiplayer updates
            // Simplified for this implementation
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }
        
        // Initialize the game
        initGame();
    });
    
    function copySessionId() {
        const sessionId = "{{ game.session_id }}";
        navigator.clipboard.writeText(sessionId).then(() => {
            alert("Session ID copied to clipboard!");
        });
    }
    
    // Auto-refresh for non-host players
    {% if role != 'host' and not game.completed %}
        setTimeout(() => {
            window.location.reload();
        }, 5000);
    {% endif %}
</script>
{% endblock %}
